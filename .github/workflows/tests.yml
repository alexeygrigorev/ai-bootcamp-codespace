name: Run Tests

on:
  push:
    branches: [ main, master, develop ]
    # Skip CI on documentation-only changes
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'documentation/**'
      - '.github/**'
  pull_request:
    branches: [ main, master, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'documentation/**'
      - '.github/**'
  workflow_dispatch:

jobs:
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      working-directory: ./capstone_project
      run: poetry install --no-interaction --no-root
    
    - name: Run unit tests
      working-directory: ./capstone_project
      run: poetry run pytest eval/tests/agent_tests/ -v
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SEC_USER_AGENT: "CI/CD Test Runner (test@example.com)"
    
    - name: Run judge tests
      working-directory: ./capstone_project
      run: poetry run pytest eval/tests/test_judge_evaluation.py -v || echo "Judge tests skipped if no evaluation results"
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SEC_USER_AGENT: "CI/CD Test Runner (test@example.com)"
      continue-on-error: true

  integration-tests:
    name: Integration Tests with Elasticsearch
    runs-on: ubuntu-latest
    
    services:
      elasticsearch:
        image: docker.elastic.co/elasticsearch/elasticsearch:8.11.0
        env:
          discovery.type: single-node
          xpack.security.enabled: false
          ES_JAVA_OPTS: "-Xms512m -Xmx512m"
        ports:
          - 9200:9200
        options: >-
          --health-cmd "curl http://localhost:9200"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Install dependencies
      working-directory: ./capstone_project
      run: poetry install --no-interaction --no-root
    
    - name: Wait for Elasticsearch
      run: |
        for i in {1..30}; do
          if curl -f http://localhost:9200 > /dev/null 2>&1; then
            echo "Elasticsearch is ready"
            exit 0
          fi
          echo "Waiting for Elasticsearch..."
          sleep 2
        done
        echo "Elasticsearch failed to start"
        exit 1
    
    - name: Verify Elasticsearch connection
      working-directory: ./capstone_project
      run: poetry run python src/check_elasticsearch.py
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SEC_USER_AGENT: "CI/CD Test Runner (test@example.com)"
    
    - name: Test imports and basic functionality
      working-directory: ./capstone_project
      run: |
        poetry run python -c "
        from src.sec_search_tools import search_sec_filings
        from elasticsearch import Elasticsearch
        es = Elasticsearch('http://localhost:9200')
        print('✅ Elasticsearch connection:', 'OK' if es.ping() else 'FAILED')
        print('✅ Imports successful')
        "
      env:
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        SEC_USER_AGENT: "CI/CD Test Runner (test@example.com)"

